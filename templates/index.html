<!DOCTYPE html>
<html>
<head>
    <title>體重記錄</title>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body>
    <h1 id="greeting">新增體重記錄</h1>
    <form id="addWeightForm">
        <label for="date">日期：</label>
        <input type="date" id="date" name="date" required>
        <label for="weight">體重：</label>
        <input type="number" step="0.1" id="weight" name="weight" required>
        <button type="submit">新增</button>
    </form>

    <h1>體重記錄列表</h1>
    <ul id="weightList"></ul>

    <h1>查詢體重記錄</h1>
    <form id="queryWeightForm">
        <label for="startDate">開始日期：</label>
        <input type="date" id="startDate" name="startDate" required>
        <label for="endDate">結束日期：</label>
        <input type="date" id="endDate" name="endDate" required>
        <button type="submit">查詢</button>
    </form>

    <script>
        async function main() {
            try {
                await liff.init({ liffId: "2005780715-O50Azkx1" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    document.getElementById('greeting').innerText = `Hello, ${profile.displayName}`;
                    const userId = profile.userId;

                    document.getElementById('addWeightForm').addEventListener('submit', function(event) {
                        event.preventDefault();
                        const date = document.getElementById('date').value;
                        const weight = document.getElementById('weight').value;

                        fetch('/weights', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ date, weight, userId })
                        }).then(response => response.json())
                          .then(data => {
                              alert('新增體重記錄：' + date + ' - ' + weight);
                              document.getElementById('date').value = '';
                              document.getElementById('weight').value = '';
                          })
                          .catch(error => {
                              console.error('新增體重記錄失敗:', error);
                          });
                    });

                    document.getElementById('queryWeightForm').addEventListener('submit', function(event) {
                        event.preventDefault();
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;

                        fetch(`/weights?start=${startDate}&end=${endDate}&userId=${userId}`)
                        .then(response => response.json())
                        .then(data => {
                            // 更新體重記錄列表
                            const weightList = document.getElementById('weightList');
                            weightList.innerHTML = '';  // 清空當前列表

                            data.forEach(record => {
                                const listItem = document.createElement('li');
                                listItem.textContent = `日期: ${record.date}, 體重: ${record.weight}`;

                                const deleteButton = document.createElement('button');
                                deleteButton.textContent = '刪除';
                                deleteButton.addEventListener('click', () => deleteWeightRecord(record.id));

                                listItem.appendChild(deleteButton);
                                weightList.appendChild(listItem);
                            });
                        })
                        .catch(error => {
                            console.error('獲取體重記錄失敗:', error);
                        });
                    });
                }
            } catch (error) {
                console.error('LIFF 初始化失敗:', error);
            }
        }

        function deleteWeightRecord(recordId) {
            fetch(`/weights/${recordId}`, {
                method: 'DELETE',
            }).then(response => {
                if (response.ok) {
                    alert('體重記錄已刪除');
                    document.querySelector(`li[data-id='${recordId}']`).remove();
                } else {
                    alert('刪除失敗');
                }
            }).catch(error => {
                console.error('刪除體重記錄失敗:', error);
            });
        }

        main();
    </script>
</body>
</html>
